<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Quiz - Namibian Learning Quiz System</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav>
        <div class="container">
            <a href="index.html" class="logo">üéì NamiQuiz</a>
            <ul class="nav-links" id="navLinks">
                <li><a href="index.html">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="quiz.html">Take Quiz</a></li>
                <li><a href="contact.html">Contact</a></li>
                <li><a href="login.html" id="loginLink">Login</a></li>
                <li><a href="signup.html" id="signupLink">Sign Up</a></li>
                <li style="display: none;" id="profileLink"><a href="profile.html">My Profile</a></li>
                <li style="display: none;" id="logoutLink"><a href="#" onclick="logoutUser()">Logout</a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="content">
        <!-- Category Selection Screen -->
        <div id="categorySelection" class="quiz-container">
            <h1 style="text-align: center; color: #667eea; margin-bottom: 30px;">Select a Quiz Category</h1>
            
            <!-- Optional Name Input -->
            <div style="max-width: 500px; margin: 0 auto 40px;">
                <div class="form-group">
                    <label for="userName" style="font-size: 18px;">Enter Your Name (Optional)</label>
                    <input type="text" id="userName" placeholder="Your name here..." 
                           style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
                    <p style="font-size: 14px; color: #666; margin-top: 8px;">
                        üí° Enter your name to track your progress, or leave blank to remain anonymous
                    </p>
                </div>
            </div>

            <div class="category-grid">
                <div class="category-card" onclick="startQuiz(1)">
                    <h3>üèõÔ∏è Namibian History</h3>
                    <p>Independence, historical events, and important figures</p>
                    <p style="margin-top: 15px; font-weight: bold;">25 Questions</p>
                </div>
                
                <div class="category-card" onclick="startQuiz(2)">
                    <h3>üåç Namibian Culture & Geography</h3>
                    <p>Traditions, languages, landmarks, and natural features</p>
                    <p style="margin-top: 15px; font-weight: bold;">25 Questions</p>
                </div>
                
                <div class="category-card" onclick="startQuiz(3)">
                    <h3>üíª Computer Science Basics</h3>
                    <p>Programming, web development, and technology</p>
                    <p style="margin-top: 15px; font-weight: bold;">20 Questions</p>
                </div>
                
                <div class="category-card" onclick="startQuiz(4)">
                    <h3>üåü General Knowledge</h3>
                    <p>Science, world facts, and everyday knowledge</p>
                    <p style="margin-top: 15px; font-weight: bold;">20 Questions</p>
                </div>
                
                <div class="category-card" onclick="startQuiz(5)">
                    <h3>üî¢ Mathematics & Logic</h3>
                    <p>Mathematical reasoning and problem-solving</p>
                    <p style="margin-top: 15px; font-weight: bold;">20 Questions</p>
                </div>
            </div>
        </div>

        <!-- Quiz Interface -->
        <div id="quizInterface" class="quiz-container" style="display: none;">
            <!-- Quiz Header -->
            <div class="quiz-header">
                <div>
                    <h2 id="categoryTitle" style="margin: 0; color: white;">Loading...</h2>
                    <p id="userNameDisplay" style="margin: 5px 0 0 0; opacity: 0.9;"></p>
                </div>
                <div style="text-align: right;">
                    <h3 id="questionCounter" style="margin: 0; color: white;">Question 1/20</h3>
                    <p id="scoreCounter" style="margin: 5px 0 0 0; opacity: 0.9;">Score: 0/0</p>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%;"></div>
            </div>

            <!-- Question Box -->
            <div class="question-box">
                <div class="question-text" id="questionText">Loading question...</div>
                
                <!-- Answer Options Container -->
                <div id="answerContainer">
                    <!-- Will be dynamically populated -->
                </div>

                <!-- Feedback Box -->
                <div class="feedback-box" id="feedbackBox">
                    <div style="display: flex; align-items: start;">
                        <span class="feedback-icon" id="feedbackIcon"></span>
                        <div style="flex: 1;">
                            <strong id="feedbackTitle"></strong>
                            <p class="feedback-text" id="feedbackText"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
                <button id="submitBtn" onclick="checkAnswer()" class="btn" style="display: none;">
                    ‚úì Submit Answer
                </button>
                <button id="nextBtn" onclick="nextQuestion()" class="btn" style="display: none;">
                    Next Question ‚Üí
                </button>
                <button id="finishBtn" onclick="finishQuiz()" class="btn" style="display: none;">
                    üèÅ Finish Quiz
                </button>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" style="display: none; text-align: center; padding: 60px;">
            <div style="font-size: 48px; margin-bottom: 20px;">‚è≥</div>
            <h2 style="color: #667eea;">Loading Quiz...</h2>
            <p>Please wait while we prepare your questions</p>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <p>&copy; 2025 Namibian Learning Quiz System. Empowering learners across Namibia.</p>
        <p>Built with ‚ù§Ô∏è for Namibian students and lifelong learners</p>
    </footer>

    <script src="js/script.js"></script>
    <script>
        // Global variables
        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let userAnswers = [];
        let selectedAnswer = null;
        let categoryId = null;
        let categoryName = '';
        let userName = '';
        let hasAnswered = false;
        let isLoggedIn = false;
        let userId = null;
        let autoSaveInterval = null;

        // Check if category is specified in URL
        window.addEventListener('DOMContentLoaded', async function() {
            // Check login status first
            await checkLoginStatus();
            
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');
            const continueQuiz = urlParams.get('continue');
            
            if (category) {
                if (continueQuiz === 'true' && isLoggedIn) {
                    // Try to load saved progress
                    await loadSavedProgress(parseInt(category));
                } else {
                    // Start new quiz
                    setTimeout(() => startQuiz(parseInt(category)), 100);
                }
            }
        });

        // Check if user is logged in
        async function checkLoginStatus() {
            try {
                const response = await fetch('php/get_user_profile.php');
                const data = await response.json();
                
                if (data.success) {
                    isLoggedIn = true;
                    userId = data.user.id;
                    userName = data.user.full_name;
                    document.getElementById('loginLink').style.display = 'none';
                    document.getElementById('signupLink').style.display = 'none';
                    document.getElementById('profileLink').style.display = 'block';
                    document.getElementById('logoutLink').style.display = 'block';
                } else {
                    isLoggedIn = false;
                }
            } catch (error) {
                isLoggedIn = false;
                console.log('Not logged in');
            }
        }

        async function logoutUser() {
            if (confirm('Are you sure you want to logout? Your current progress will be saved.')) {
                if (isLoggedIn && questions.length > 0 && currentQuestionIndex < questions.length) {
                    await saveProgress();
                }
                await fetch('php/logout.php');
                window.location.href = 'index.html';
            }
        }

        // Load saved progress
        async function loadSavedProgress(catId) {
            try {
                const response = await fetch(`php/get_incomplete_quizzes.php`);
                const data = await response.json();
                
                if (data.success && data.quizzes.length > 0) {
                    const savedQuiz = data.quizzes.find(q => q.category_id === catId);
                    
                    if (savedQuiz) {
                        // Ask user if they want to continue
                        const continueConfirm = confirm(
                            `You have a saved quiz in ${savedQuiz.category_name}.\n` +
                            `Question ${savedQuiz.current_question}/${savedQuiz.total_questions}\n\n` +
                            `Continue from where you left off?`
                        );
                        
                        if (continueConfirm) {
                            // Load the saved state
                            categoryId = savedQuiz.category_id;
                            currentQuestionIndex = savedQuiz.current_question;
                            score = savedQuiz.score;
                            
                            // Get questions and user answers from saved data
                            const savedProgress = await fetch(`php/get_saved_quiz_data.php?user_id=${userId}&category_id=${catId}`);
                            const progressData = await savedProgress.json();
                            
                            if (progressData.success) {
                                questions = JSON.parse(progressData.data.questions_data);
                                userAnswers = JSON.parse(progressData.data.user_answers);
                                categoryName = savedQuiz.category_name;
                                
                                // Show quiz interface
                                document.getElementById('categorySelection').style.display = 'none';
                                document.getElementById('quizInterface').style.display = 'block';
                                document.getElementById('categoryTitle').textContent = categoryName;
                                document.getElementById('userNameDisplay').textContent = `Welcome back, ${userName}!`;
                                
                                // Start auto-save
                                startAutoSave();
                                
                                loadQuestion();
                                return;
                            }
                        }
                    }
                }
                
                // If no saved progress or user chose not to continue, start new quiz
                startQuiz(catId);
            } catch (error) {
                console.error('Error loading saved progress:', error);
                startQuiz(catId);
            }
        }

        async function startQuiz(catId) {
            categoryId = catId;
            
            // Get username from input or use logged-in user's name
            if (!isLoggedIn) {
                userName = document.getElementById('userName').value.trim() || 'Anonymous';
            }
            
            // Show loading screen
            document.getElementById('categorySelection').style.display = 'none';
            document.getElementById('loadingScreen').style.display = 'block';

            try {
                // Fetch questions from database
                const response = await fetch(`php/get_questions.php?category_id=${categoryId}`);
                const data = await response.json();

                if (data.success) {
                    questions = data.questions;
                    categoryName = data.category_name;
                    
                    // Initialize quiz
                    currentQuestionIndex = 0;
                    score = 0;
                    userAnswers = [];
                    
                    // Hide loading and show quiz
                    document.getElementById('loadingScreen').style.display = 'none';
                    document.getElementById('quizInterface').style.display = 'block';
                    
                    // Set category title
                    document.getElementById('categoryTitle').textContent = categoryName;
                    document.getElementById('userNameDisplay').textContent = `Welcome, ${userName}!`;
                    
                    // Start auto-save if logged in
                    if (isLoggedIn) {
                        startAutoSave();
                    }
                    
                    // Load first question
                    loadQuestion();
                } else {
                    alert('Error loading questions: ' + data.error);
                    window.location.href = 'quiz.html';
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to load quiz. Please check your connection and try again.');
                window.location.href = 'quiz.html';
            }
        }

        function loadQuestion() {
            if (currentQuestionIndex >= questions.length) {
                finishQuiz();
                return;
            }

            const question = questions[currentQuestionIndex];
            hasAnswered = false;
            selectedAnswer = null;

            // Update counters
            document.getElementById('questionCounter').textContent = 
                `Question ${currentQuestionIndex + 1}/${questions.length}`;
            document.getElementById('scoreCounter').textContent = 
                `Score: ${score}/${currentQuestionIndex}`;
            
            // Update progress bar
            const progress = ((currentQuestionIndex) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';

            // Display question
            document.getElementById('questionText').textContent = question.question_text;

            // Hide feedback
            document.getElementById('feedbackBox').classList.remove('show', 'correct', 'incorrect');

            // Clear previous answers
            const answerContainer = document.getElementById('answerContainer');
            answerContainer.innerHTML = '';

            // Show appropriate answer interface based on question type
            if (question.question_type === 'multiple_choice') {
                displayMultipleChoice(question);
            } else if (question.question_type === 'true_false') {
                displayTrueFalse(question);
            } else if (question.question_type === 'text_input') {
                displayTextInput(question);
            }

            // Show submit button
            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'none';
        }

        function displayMultipleChoice(question) {
            const answerContainer = document.getElementById('answerContainer');
            answerContainer.className = 'answer-options';

            const options = [
                { label: 'A', text: question.option_a },
                { label: 'B', text: question.option_b },
                { label: 'C', text: question.option_c },
                { label: 'D', text: question.option_d }
            ];

            options.forEach(option => {
                if (option.text) {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'answer-option';
                    optionDiv.textContent = `${option.label}. ${option.text}`;
                    optionDiv.onclick = () => selectAnswer(option.label, optionDiv);
                    answerContainer.appendChild(optionDiv);
                }
            });
        }

        function displayTrueFalse(question) {
            const answerContainer = document.getElementById('answerContainer');
            answerContainer.className = 'answer-options';

            const options = [
                { label: 'A', text: question.option_a },
                { label: 'B', text: question.option_b }
            ];

            options.forEach(option => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'answer-option';
                optionDiv.textContent = option.text;
                optionDiv.onclick = () => selectAnswer(option.label, optionDiv);
                answerContainer.appendChild(optionDiv);
            });
        }

        function displayTextInput(question) {
            const answerContainer = document.getElementById('answerContainer');
            answerContainer.innerHTML = `
                <input type="text" 
                       id="textAnswer" 
                       class="text-answer-input" 
                       placeholder="Type your answer here..."
                       onkeypress="if(event.key === 'Enter') checkAnswer()">
                <p style="margin-top: 10px; color: #666; font-size: 14px;">
                    üí° Hint: Check the question for format guidance
                </p>
            `;
            
            // Focus on input
            setTimeout(() => document.getElementById('textAnswer').focus(), 100);
        }

        function selectAnswer(answer, element) {
            if (hasAnswered) return;

            // Remove previous selection
            document.querySelectorAll('.answer-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Mark new selection
            element.classList.add('selected');
            selectedAnswer = answer;
        }

        function checkAnswer() {
            if (hasAnswered) return;

            const question = questions[currentQuestionIndex];
            let userAnswer = '';
            let isCorrect = false;

            // Get user's answer based on question type
            if (question.question_type === 'text_input') {
                const textInput = document.getElementById('textAnswer');
                if (!textInput || !textInput.value.trim()) {
                    alert('Please enter an answer!');
                    return;
                }
                userAnswer = textInput.value.trim();
                
                // Check if answer is correct (case-insensitive)
                isCorrect = userAnswer.toLowerCase() === question.text_answer.toLowerCase();
            } else {
                if (!selectedAnswer) {
                    alert('Please select an answer!');
                    return;
                }
                userAnswer = selectedAnswer;
                isCorrect = selectedAnswer.toUpperCase() === question.correct_answer.toUpperCase();
            }

            hasAnswered = true;
            userAnswers.push(userAnswer);

            // Update score
            if (isCorrect) {
                score++;
            }

            // Show feedback
            showFeedback(isCorrect, question);

            // Update score counter
            document.getElementById('scoreCounter').textContent = 
                `Score: ${score}/${currentQuestionIndex + 1}`;

            // Show appropriate button
            document.getElementById('submitBtn').style.display = 'none';
            
            if (currentQuestionIndex < questions.length - 1) {
                document.getElementById('nextBtn').style.display = 'inline-block';
            } else {
                document.getElementById('finishBtn').style.display = 'inline-block';
            }

            // Highlight correct/incorrect answers
            if (question.question_type !== 'text_input') {
                highlightAnswers(question, userAnswer);
            }
        }

        function showFeedback(isCorrect, question) {
            const feedbackBox = document.getElementById('feedbackBox');
            const feedbackIcon = document.getElementById('feedbackIcon');
            const feedbackTitle = document.getElementById('feedbackTitle');
            const feedbackText = document.getElementById('feedbackText');

            feedbackBox.classList.add('show');
            
            if (isCorrect) {
                feedbackBox.classList.add('correct');
                feedbackBox.classList.remove('incorrect');
                feedbackIcon.textContent = '‚úÖ';
                feedbackTitle.textContent = 'Correct!';
            } else {
                feedbackBox.classList.add('incorrect');
                feedbackBox.classList.remove('correct');
                feedbackIcon.textContent = '‚ùå';
                feedbackTitle.textContent = 'Incorrect';
            }

            feedbackText.textContent = question.explanation;

            // Scroll to feedback
            feedbackBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function highlightAnswers(question, userAnswer) {
            const options = document.querySelectorAll('.answer-option');
            const correctAnswer = question.correct_answer.toUpperCase();

            options.forEach(option => {
                const optionLetter = option.textContent.charAt(0);
                
                if (optionLetter === correctAnswer) {
                    option.classList.add('correct');
                    option.classList.remove('selected');
                } else if (optionLetter === userAnswer.toUpperCase() && userAnswer.toUpperCase() !== correctAnswer) {
                    option.classList.add('incorrect');
                    option.classList.remove('selected');
                }
                
                // Disable clicking
                option.style.pointerEvents = 'none';
            });
        }

        function nextQuestion() {
            currentQuestionIndex++;
            
            // Auto-save progress for logged-in users
            if (isLoggedIn && currentQuestionIndex < questions.length) {
                saveProgress();
            }
            
            loadQuestion();
        }

        function finishQuiz() {
            // Stop auto-save
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            // Save results to sessionStorage
            const results = {
                score: score,
                totalQuestions: questions.length,
                categoryName: categoryName,
                categoryId: categoryId,
                userName: userName || 'Anonymous',
                userAnswers: userAnswers,
                questions: questions
            };

            sessionStorage.setItem('quizResults', JSON.stringify(results));

            // Redirect to results page
            window.location.href = 'results.html';
        }

        // Auto-save progress every 30 seconds
        function startAutoSave() {
            if (!isLoggedIn) return;
            
            autoSaveInterval = setInterval(() => {
                if (currentQuestionIndex < questions.length) {
                    saveProgress();
                    console.log('Progress auto-saved');
                }
            }, 30000); // 30 seconds
        }

        // Save progress to database
        async function saveProgress() {
            if (!isLoggedIn) return;
            
            try {
                const response = await fetch('php/save_progress.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        category_id: categoryId,
                        current_question: currentQuestionIndex,
                        total_questions: questions.length,
                        score: score,
                        user_answers: userAnswers,
                        questions: questions
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('Progress saved successfully');
                } else {
                    console.error('Failed to save progress:', data.message);
                }
            } catch (error) {
                console.error('Error saving progress:', error);
            }
        }

        // Prevent accidental page refresh
        window.addEventListener('beforeunload', function(e) {
            if (questions.length > 0 && currentQuestionIndex < questions.length) {
                // Save progress before leaving
                if (isLoggedIn) {
                    saveProgress();
                }
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>